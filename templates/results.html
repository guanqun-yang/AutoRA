<!DOCTYPE html>
<html>
<head>
    <title>Search Results</title>
    <style>
        .highlight-green {
            background-color: lightgreen;
            padding: 10px;
            margin: 5px 0;
        }
        .highlight-gray {
            background-color: lightgray;
            padding: 10px;
            margin: 5px 0;
        }
        a {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
        a:hover {
            color: darkblue;
        }
        .score {
            font-size: small;
            color: gray;
        }
    </style>
    <script>
        // Function to toggle highlight dynamically
        function toggleHighlight(id, value) {
            const item = document.getElementById(`paper-${id}`);
            if (value === "relevant") {
                item.className = "highlight-green";
            } else if (value === "irrelevant") {
                item.className = "highlight-gray";
            }
        }

        // Function to export selected papers
        function exportPapers() {
            const relevantIds = [];
            const irrelevantIds = [];
            document.querySelectorAll(".relevance-radio").forEach(radio => {
                if (radio.checked && radio.value === "relevant") {
                    relevantIds.push(radio.dataset.id);
                } else if (radio.checked && radio.value === "irrelevant") {
                    irrelevantIds.push(radio.dataset.id);
                }
            });

            fetch("/export", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ relevant_ids: relevantIds, irrelevant_ids: irrelevantIds }),
            })
            .then(response => response.json())
            .then(data => {
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: "application/json" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "papers.json";
                a.click();
            });
        }
    </script>
</head>
<body>
    <h1>BM25 Paper Search</h1>

    <!-- New Search Form -->
    <form method="post" action="/">
        <label for="query">Query:</label>
        <input type="text" id="query" name="query" value="{{ query }}" required>
        <label for="num_papers">Number of Papers to Retrieve:</label>
        <input type="number" id="num_papers" name="num_papers" min="1" required>
        <button type="submit">Search</button>
    </form>

    <!-- Results Section -->
    <h2>Search Results</h2>
    <button onclick="exportPapers()">Export Papers (JSON)</button>
    <div>
        {% for paper in papers %}
        <div id="paper-{{ loop.index0 }}" class="">
            <a href="https://www.google.com/search?q={{ paper.title | urlencode }}" target="_blank">
                <strong>{{ paper.venue }} {{paper.year}} | {{ paper.title }}</strong>
            </a><br>
            <em>{{ paper.authors }}</em><br>
            <span class="score">Score: {{ paper.score }}</span><br>
            <label>
                <input type="radio" class="relevance-radio" name="relevance-{{ loop.index0 }}"
                       data-id="{{ loop.index0 }}" value="relevant"
                       onchange="toggleHighlight('{{ loop.index0 }}', 'relevant')"> Relevant
            </label>
            <label>
                <input type="radio" class="relevance-radio" name="relevance-{{ loop.index0 }}"
                       data-id="{{ loop.index0 }}" value="irrelevant"
                       onchange="toggleHighlight('{{ loop.index0 }}', 'irrelevant')"> Irrelevant
            </label>
        </div>
        {% endfor %}
    </div>
</body>
</html>
